!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs/Subject"),require("@angular/common")):"function"==typeof define&&define.amd?define("ngx-uploadx",["exports","@angular/core","rxjs/Subject","@angular/common"],t):t(e["ngx-uploadx"]={},e.ng.core,e.Rx,e.ng.common)}(this,function(e,i,t,s){"use strict";var n=function(){},o=function(){function e(e,t,s){void 0===e&&(e=1e3),void 0===t&&(t=120*e),void 0===s&&(s=2),this.minInterval=e,this.maxInterval=t,this.k=s,this.delay=this.minInterval}return e.prototype.wait=function(){var t=this;return new Promise(function(e){setTimeout(e,t.delay+Math.floor(Math.random()*t.minInterval)),t.delay=Math.min(t.delay*t.k,t.maxInterval)})},e.prototype.reset=function(){this.delay=this.minInterval},e}(),r=function(){var t=Array(1).fill(s());function s(){return new XMLHttpRequest}return{release:function(e){e.onreadystatechange=null,e.onerror=null,e.onload=null,e.upload.onprogress=null,t.push(e)},getInstance:function(){return t.length?t.pop():s()},get size(){return t.length},set size(e){t=Array(e).fill(s())}}}(),a=function(){function e(e,t){this.file=e,this.options=t,this.uploadId=Math.random().toString(36).substring(2,15),this.name=e.name,this.size=e.size,this.mimeType=e.type||"application/octet-stream",this.status="added",this.retry=new o}return e.prototype.configure=function(e){if(void 0===e&&(e={}),"added"===this.status){var t=e.metadata,s=e.headers;this.metadata=Object.assign({name:this.name,mimeType:this.mimeType},this.options.metadata,t),this.headers=this.options.headers instanceof Function?this.options.headers(this.file):Object.assign({},this.options.headers,s),this.url=this.options.url,this.method=this.options.method}this.status="queue"},Object.defineProperty(e.prototype,"status",{get:function(){return this._status},set:function(e){this._status=e,this.notifyState(),"cancelled"!==e&&"paused"!==e||this.abort()},enumerable:!0,configurable:!0}),e.prototype.notifyState=function(){var e=this,t={file:this.file,name:this.name,progress:this.progress,remaining:this.remaining,response:this.response,size:this.size,speed:this.speed,status:this._status,uploadId:this.uploadId,URI:this.url};setTimeout(function(){e.options.subj.next(t)})},e.prototype.setHeaders=function(t){var s=this;this.headers&&Object.keys(this.headers).forEach(function(e){return t.setRequestHeader(e,s.headers[e])})},e.prototype.upload=function(){var e=this;if("added"===this.status&&this.configure(),this.status="uploading",0<this.progress)return this.resume();var t=new XMLHttpRequest;t.responseType="json",t.open(this.method,this.options.url,!0),this.options.withCredentials&&(t.withCredentials=!0),this.setHeaders(t),this.options.token&&t.setRequestHeader("Authorization","Bearer "+this.options.token),t.setRequestHeader("Content-Type","application/json; charset=UTF-8"),t.setRequestHeader("X-Upload-Content-Length",this.size.toString()),t.setRequestHeader("X-Upload-Content-Type",this.mimeType),t.onload=function(){t.status<400&&199<t.status?(e.url=t.getResponseHeader("Location"),e.startTime=e.startTime||(new Date).getTime(),e.sendFile()):(e.response=t.response,e.status="error")},t.send(JSON.stringify(this.metadata))},e.prototype.resume=function(){var t=this,s=r.getInstance();"json"!==s.responseType&&(s.responseType="json"),s.open("PUT",this.url,!0),this.options.withCredentials&&(s.withCredentials=!0),s.setRequestHeader("Content-Range","bytes */"+this.size),s.setRequestHeader("Content-Type",this.mimeType),this.setHeaders(s);var n=function(){499<s.status||!s.status?(r.release(s),t.retry.wait().then(function(){return t.resume()})):(t.response=s.response||{error:{code:s.status,message:s.statusText}},t.status="error",r.release(s),t.options.nextFile())};s.onerror=n,s.onload=function(){if(200===s.status||201===s.status)t.progress=100,t.response=s.response,t.status="complete",r.release(s),t.options.nextFile();else if(s.status&&s.status<400){var e=+s.getResponseHeader("Range").split("-")[1]+1;t.retry.reset(),r.release(s),t.abort=t.sendFile(e)}else n()},s.send()},e.prototype.sendFile=function(n){var i=this;if(void 0===n&&(n=0),"cancelled"!==this.status&&"paused"!==this.status){var o=this.options.chunkSize?n+this.options.chunkSize:this.size;o=o>this.size?this.size:o;var e=this.file.slice(n,o),t=r.getInstance();"json"!==t.responseType&&(t.responseType="json"),t.open("PUT",this.url,!0),this.options.withCredentials&&(t.withCredentials=!0),t.setRequestHeader("Content-Range","bytes "+n+"-"+(o-1)+"/"+this.size),t.setRequestHeader("Content-Type",this.mimeType),this.setHeaders(t);var s=function(){499<t.status||!t.status?(r.release(t),i.retry.wait().then(function(){return i.resume()})):(i.response=t.response||{error:{code:+t.status,message:t.statusText}},i.status="error",r.release(t),i.options.nextFile())};return t.onerror=s,t.onload=function(){if(200===t.status||201===t.status)i.progress=100,i.response=t.response,i.status="complete",r.release(t),i.options.nextFile();else if(t.status&&t.status<400){var e=+t.getResponseHeader("Range").split("-")[1]+1;i.retry.reset(),r.release(t),i.abort=i.sendFile(e)}else s()},t.upload.onprogress=function(e){var t=e.lengthComputable?n+(o-n)*(e.loaded/e.total):n;i.progress=+(t/i.size*100).toFixed(2);var s=(new Date).getTime();i.speed=Math.round(t/(s-i.startTime)*1e3),i.remaining=Math.ceil((i.size-t)/i.speed),i.notifyState()},t.send(e),function(){t.abort()}}},e}(),u=function(){function e(){this.subj=new t.Subject,this.queue=[],this.concurrency=2,this.autoUpload=!0}return Object.defineProperty(e.prototype,"uploaderOptions",{get:function(){var e=this;return{method:this.options.method||"POST",url:this.options.url||"/upload/",headers:this.options.headers,token:this.options.token,chunkSize:this.options.chunkSize||0,withCredentials:this.options.withCredentials||!1,subj:this.subj,nextFile:function(){return e.processQueue()}}},enumerable:!0,configurable:!0}),e.prototype.init=function(e){return this.options=e,this.concurrency=e.concurrency||this.concurrency,this.autoUpload=e.autoUpload||!1,this.subj.asObservable()},e.prototype.handleFileList=function(e){for(var t=0;t<e.length;t++){var s=new a(e.item(t),this.uploaderOptions);this.queue.push(s)}this.autoUpload&&(this.queue.forEach(function(e){e.configure()}),this.processQueue())},e.prototype.control=function(t){switch(t.action){case"cancelAll":this.queue.filter(function(e){return"complete"!==e.status}).map(function(e){return e.status="cancelled"});break;case"pauseAll":this.queue.filter(function(e){return"complete"!==e.status}).map(function(e){return e.status="paused"});break;case"uploadAll":this.queue.filter(function(e){return"complete"!==e.status&&"uploading"!==e.status}).map(function(e){return e.status="queue"}),this.processQueue();break;case"upload":var s=t.uploadId||t.itemOptions.uploadId;this.queue.find(function(e){return e.uploadId===s}).configure(t.itemOptions),this.processQueue();break;case"cancel":this.queue.find(function(e){return e.uploadId===t.uploadId}).status="cancelled";break;case"pause":this.queue.find(function(e){return e.uploadId===t.uploadId}).status="paused"}},e.prototype.processQueue=function(){var e=this.queue.filter(function(e){return"uploading"===e.status}),t=this.queue.findIndex(function(e){return"complete"===e.status});-1!==t&&this.queue.splice(t,1),this.queue.filter(function(e){return"queue"===e.status}).slice(0,this.concurrency-e.length).forEach(function(e){e.upload()})},e}();u.decorators=[{type:i.Injectable}];var p=function(){function e(e,t,s){var n=this;this.elementRef=e,this.renderer=t,this.uploadService=s,this.uploadxState=new i.EventEmitter,this.fileListener=function(){n.elementRef.nativeElement.files&&n.uploadService.handleFileList(n.elementRef.nativeElement.files)}}return Object.defineProperty(e.prototype,"uploadxAction",{set:function(e){e&&this.uploadService&&this.uploadService.control(e)},enumerable:!0,configurable:!0}),e.prototype.ngOnInit=function(){this.uploadx&&(this.uploadx.allowedTypes&&this.renderer.setAttribute(this.elementRef.nativeElement,"accept",this.uploadx.allowedTypes),this.uploadService.init(this.uploadx)),this.uploadxState.emit(this.uploadService.subj.asObservable()),this.listenerFn=this.renderer.listen(this.elementRef.nativeElement,"change",this.fileListener)},e.prototype.ngOnDestroy=function(){this.listenerFn&&this.listenerFn()},e}();p.decorators=[{type:i.Directive,args:[{selector:"[uploadx]"}]}],p.ctorParameters=function(){return[{type:i.ElementRef},{type:i.Renderer2},{type:u}]},p.propDecorators={uploadxState:[{type:i.Output}],uploadx:[{type:i.Input,args:["uploadx"]}],uploadxAction:[{type:i.Input,args:["uploadxAction"]}]};var l=function(){};l.decorators=[{type:i.NgModule,args:[{imports:[s.CommonModule],declarations:[p],exports:[p],providers:[u]}]}],e.UploadxOptions=n,e.UploadxService=u,e.UploadxModule=l,e.Éµa=p,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=ngx-uploadx.umd.min.js.map
